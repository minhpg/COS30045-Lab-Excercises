<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Data Visualisation Exercise 5.3" />
    <meta name="keywords" content="HTML CSS JS" />
    <meta name="author" content="Gia Minh Pham - 103808249" />

    <title>Task 5.3 D3 Adding and Removing Data</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

    <style></style>
  </head>

  <body class="container mx-auto py-6 flex flex-col items-center h-screen">
    <main class="prose flex-1">
      <h1>D3 Adding and Removing Data</h1>
      <figure id="bar-chart"></figure>
      <div class="flex flex-col gap-2">
        <div class="flex gap-2 w-full">
          <div
            class="flex items-center gap-3 bg-white border border-gray-200 text-black text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full px-3 py-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-6 h-6 text-gray-500"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z"
              />
            </svg>
            <select
              id="select-transition-animation"
              class="p-0 border-transparent focus:border-transparent focus:ring-0 w-full outline-none text-sm"
            >
              <option disabled class="text-gray-500">
                Select an ease animation
              </option>
            </select>
          </div>
          <div
            class="flex items-center gap-3 bg-white border border-gray-200 text-black text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full px-3 py-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-6 h-6 text-gray-500"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
              />
            </svg>
            <input
              placeholder="Duration (ms)"
              type="number"
              class="text-black text-sm p-0 border-transparent focus:border-transparent focus:ring-0 w-full outline-none"
              id="input-transition-duration"
            />
          </div>
        </div>
        <div class="flex gap-3">
          <button
            id="btn-add-data"
            class="bg-blue-500 hover:bg-blue-600 transition-all rounded-lg text-white px-3 py-2 text-sm w-full"
          >
            Add data
          </button>
          <div
            class="flex items-center gap-3 bg-white border border-gray-200 text-black text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full px-3 py-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-6 h-6 text-gray-500"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"
              />
            </svg>

            <input
              placeholder="Number of bars to add"
              type="number"
              class="text-black text-sm p-0 border-transparent focus:border-transparent focus:ring-0 w-full outline-none"
              id="input-num-add"
            />
          </div>
        </div>
        <div class="flex gap-3">
          <button
            id="btn-update-shift"
            class="bg-blue-500 hover:bg-blue-600 transition-all rounded-lg text-white px-4 py-3 text-sm w-full"
          >
            Shift
          </button>
          <button
            id="btn-update-pop"
            class="bg-blue-500 hover:bg-blue-600 transition-all rounded-lg text-white px-4 py-3 text-sm w-full"
          >
            Pop
          </button>
        </div>
        <button
          id="btn-update-graph"
          class="bg-blue-500 hover:bg-blue-600 transition-all rounded-lg text-white px-4 py-3 text-sm"
        >
          Update data
        </button>
        <button
          id="btn-renew-graph"
          class="bg-blue-500 hover:bg-blue-600 transition-all rounded-lg text-white px-4 py-3 text-sm"
        >
          Renew data
        </button>
      </div>
    </main>

    <footer class="font-black p-6 text-center">
      <div class="font-light">Gia Minh Pham - 103808249</div>
      <div>COS30045 Data Visualisation</div>
    </footer>

    <script>
      /** Graph configs */
      const width = document.getElementById("bar-chart").offsetWidth;
      const height = 500;
      const margin = 0;
      const maxValue = 25;
      const maxLength = 25;
      const padding = (width / maxLength) * 0.05;
      const ticks = 5;

      /** Default transition settings */
      let transitionDuration = 3000;
      let transitionEase = "easeElastic";

      /** Add dataset settings */
      let addDataMax = 5;

      /** Generate random dataset*/
      const generateDataset = (generateMaxLength = maxLength) => {
        /** Create array with length */
        return (
          Array(generateMaxLength)
            /** Temporary fill with 0s */
            .fill(0)
            /** Map to random function */
            .map(
              () => Math.ceil(Math.random() * maxValue) // Math.random*value => creates value between 0-maxValue
            )
        );
      };

      /** Declare D3 ease values */
      const d3Eases = [
        {
          name: "easeLinear",
          d3Ease: d3.easeLinear,
        },
        {
          name: "easeQuad",
          d3Ease: d3.easeQuad,
        },
        {
          name: "easeCubic",
          d3Ease: d3.easeCubic,
        },
        {
          name: "easePoly",
          d3Ease: d3.easePoly,
        },
        {
          name: "easeSin",
          d3Ease: d3.easeSin,
        },
        {
          name: "easeExp",
          d3Ease: d3.easeExp,
        },
        {
          name: "easeCircle",
          d3Ease: d3.easeCircle,
        },
        {
          name: "easeBounce",
          d3Ease: d3.easeBounce,
        },
        {
          name: "easeBack",
          d3Ease: d3.easeBack,
        },
        {
          name: "easeElastic",
          d3Ease: d3.easeElastic,
        },
      ];

      /** Initialize dataset */
      let currentDataset = generateDataset();

      /** Calculate width & height with margin */

      const innerWidth = width - margin * 2;
      const innerHeight = height - margin * 2;

      /** Initialize x/y scales */
      let xScale = d3
        .scaleBand()
        .domain(d3.range(currentDataset.length))
        .range([0, innerWidth]);

      let yScale = d3
        .scaleLinear()
        .domain([0, d3.max(currentDataset)])
        .range([0, innerHeight]);

      /** Create SVG DOM object */
      const svg = d3
        .select("#bar-chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g");

      /** Create caption */
      d3.select("#bar-chart")
        .append("figcaption")
        .text("Figure 1. Test bar chart data binding with SVG");

      /** Create ease select options from ease array */
      d3.select("#select-transition-animation")
        .selectAll("option")
        .data(d3Eases)
        .enter()
        .append("option")
        .attr("value", (d) => d.name)
        .attr("selected", (d) => d.name === transitionEase)
        .text((d) => d.name);

      /** Assign default input values */
      d3.select("#input-transition-duration").attr("value", transitionDuration);
      d3.select("#input-num-add").attr("value", addDataMax);

      /** Build transition function */
      const buildTransition = () => {
        return d3
          .transition()
          .delay(
            (_, index) => (index / currentDataset.length) * transitionDuration
          ) // Staggered delay
          .duration(transitionDuration)
          .ease(
            d3Eases.find(
              (d) => d.name === transitionEase // Find ease by name
            ).d3Ease
          );
      };

      /** Draw graph function
       *
       *  Why?
       *  I want to reuse this function instead of having to manage graph behaviours in multiple places
       *
       */
      const drawGraph = () => {
        /** Reinitialize x scale */
        xScale = d3
          .scaleBand()
          .domain(d3.range(currentDataset.length))
          .range([0, innerWidth]);
        /** Draw bars */
        const bars = svg.selectAll("rect").data(currentDataset);

        /** Exit bars */
        bars
          .exit()
          .transition(buildTransition())
          .attr("x", innerWidth)
          .remove();

        /** Transition existing bars */
        bars
          .transition(buildTransition())
          .attr("x", (_, index) => index * xScale.bandwidth() + padding)
          .attr("width", xScale.bandwidth() - padding)
          .attr("y", (data) => innerHeight - yScale(data))
          .attr("height", (data) => yScale(data));

        /** Bring in new bars */
        bars
          .enter()
          .append("rect")
          .attr("x", innerWidth)
          .attr("y", (data) => innerHeight - yScale(data))
          .attr("height", (data) => yScale(data))
          .merge(bars)
          .transition(buildTransition())
          .attr("x", (_, index) => index * xScale.bandwidth() + padding)
          .attr("y", (data) => innerHeight - yScale(data))
          .attr("width", xScale.bandwidth() - padding)
          .attr("height", (data) => yScale(data));
      };

      drawGraph();

      /** Add new data to graph */
      const mergeGraph = ({ dataset }) => {
        /** Merge dataset with spread */
        currentDataset = [...currentDataset, ...dataset];
        drawGraph();
      };

      /** Pop bar to right */
      const popGraph = () => {
        currentDataset.pop();
        drawGraph();
      };

      /** Shift bar to left
       *  WIP: make so that update graph runs after bar shift left transition
       */
      const shiftGraph = () => {
        currentDataset.shift();
        drawGraph();
      };

      /** Renew graph */
      const renewGraph = () => {
        if (currentDataset.length == maxLength) return;
        /** Generate new dataset */
        currentDataset = generateDataset(maxLength);
        drawGraph();
      };

      /** Update data button event listener */
      d3.select("#btn-update-graph").on("click", () => {
        /** Generate new dataset */
        currentDataset = generateDataset(currentDataset.length);
        drawGraph();
      });

      /** Transition ease select event listeners */
      d3.select("#select-transition-animation").on("change", (event) => {
        /** Assign new ease */
        transitionEase = event.target.value;
      });

      /** Transition duration input event listeners */
      d3.select("#input-transition-duration").on("input", (event) => {
        /** Assign new duration */
        transitionDuration = event.target.value;
      });

      /** Max data add input event listeners */
      d3.select("#input-num-add").on("input", (event) => {
        /** Assign new duration */
        addDataMax = parseInt(event.target.value);
      });

      /** Update data button event listener */
      d3.select("#btn-add-data").on("click", () => {
        /** Generate new dataset */
        console.log(addDataMax);
        const dataset = generateDataset(addDataMax);
        mergeGraph({ dataset });
      });

      /** Shift data button event listener */
      d3.select("#btn-update-shift").on("click", shiftGraph);

      /** Pop data button event listener */
      d3.select("#btn-update-pop").on("click", popGraph);

      /** Renew data button event listener */
      d3.select("#btn-renew-graph").on("click", renewGraph);
    </script>
  </body>
</html>
